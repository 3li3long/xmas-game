<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•æ‹‰éœ¸æ´»å‹•</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- V5 RWD æ¨£å¼ (ç¶­æŒä¸è®Š) --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a472a;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 10px;
            overflow: hidden;
        }
        h1 {
            color: #f0c419;
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 10px;
            font-size: clamp(1.5rem, 5vw, 2rem);
            text-align: center;
        }
        .info-text { font-size: 1rem; color: #ddd; margin-bottom: 15px; text-align: center;}
        
        .round-indicator {
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #f0c419;
        }

        .machine-container {
            background-color: #c0392b;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border: 5px solid #f0c419;
            width: 95%;
            max-width: 350px;
            min-width: 280px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .slots-window {
            background-color: #fff;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 5px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            width: 100%;
        }
        .reel {
            font-size: clamp(2.5rem, 10vw, 3.5rem);
            width: 33%;
            height: 70px;
            line-height: 75px;
            text-align: center;
            border-right: 2px solid #ddd;
            color: #333;
            display: flex; align-items: center; justify-content: center;
        }
        .reel:last-child { border-right: none; }
        .reel img { width: 80%; height: 80%; object-fit: contain; }
        .spin-btn {
            background: linear-gradient(to bottom, #f0c419, #d4ac0d);
            border: none;
            padding: 15px 0;
            width: 100%;
            font-size: 1.5rem;
            color: #333;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #997c09;
        }
        .spin-btn:active { transform: translateY(5px); box-shadow: 0 0 0 #997c09; }
        .spin-btn:disabled { background: #95a5a6; color: #555; cursor: not-allowed; box-shadow: none; transform: translateY(5px); }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
            padding: 20px;
        }
        .modal-content {
            background: #fff; color: #333;
            width: 100%; max-width: 340px;
            padding: 25px 20px; border-radius: 20px;
            text-align: center; position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            border: 4px solid #c0392b;
            animation: popIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .modal-img-placeholder {
            width: 100px; height: 100px;
            background-color: #fafafa;
            margin: 0 auto 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem;
            border-radius: 10px; border: 2px dashed #ccc;
        }
        .modal-img-placeholder img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }

        .modal-title { font-size: 1.4rem; color: #c0392b; margin-bottom: 8px; font-weight: bold; }
        .modal-desc { font-size: 0.9rem; color: #555; margin-bottom: 20px; line-height: 1.4; white-space: pre-line; }
        
        .action-btn { background: #2ecc71; color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 1.1rem; cursor: pointer; width: 100%; margin-bottom: 10px; }
        
        .prize-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .prize-item {
            border: 2px solid #eee; border-radius: 10px; padding: 10px;
            display: flex; align-items: center; text-align: left;
            transition: all 0.2s; cursor: pointer;
        }
        .prize-item:hover { border-color: #f0c419; background: #fffdf0; }
        .prize-item.selected { border-color: #c0392b; background: #fff0f0; border-width: 3px; }
        
        .prize-icon { font-size: 2rem; margin-right: 15px; width: 40px; text-align: center;}
        .prize-info { flex: 1; }
        .prize-name { font-weight: bold; color: #333; font-size: 1rem;}
        .prize-sub { font-size: 0.8rem; color: #777; }
        
        .snow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; background-image: url('data:image/svg+xml;utf8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="2" fill="white" opacity="0.3"/></svg>'); animation: snow 10s linear infinite; }
        @keyframes snow { from { background-position: 0 0; } to { background-position: 0 500px; } }
    </style>
</head>
<body>
    <div class="snow"></div>
    <h1 id="welcome-msg">ğŸ„ è–èª•å¥½ç¦®æ‹‰éœ¸ ğŸ„</h1>
    <div class="info-text" id="status-msg">é€£ç·šä¸­...</div>
    <div class="round-indicator" id="round-text">æº–å‚™é–‹å§‹ (0/3)</div>

    <div class="machine-container">
        <div class="slots-window">
            <div class="reel" id="reel1">ğŸ…</div>
            <div class="reel" id="reel2">ğŸ…</div>
            <div class="reel" id="reel3">ğŸ…</div>
        </div>
        <button class="spin-btn" id="spinBtn" onclick="playGame()" disabled>è¼‰å…¥ä¸­...</button>
    </div>

    <div class="modal-overlay" id="resultModal">
        <div class="modal-content">
            <div class="modal-img-placeholder" id="modalImg">ğŸ</div>
            <div class="modal-title" id="modalTitle">æ¨™é¡Œ</div>
            <div class="modal-desc" id="modalDesc">æ•˜è¿°</div>
            <button class="action-btn" id="modalBtn" onclick="nextRound()">æ”¾å…¥èƒŒåŒ…ï¼Œç¹¼çºŒè½‰</button>
        </div>
    </div>

    <div class="modal-overlay" id="selectionModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ‰ æ­å–œå®Œæˆï¼</div>
            <div class="modal-desc">æ‚¨æœ‰ 3 æ¬¡ä¸­çç´€éŒ„ï¼Œè«‹ **æ“‡ä¸€** é ˜å–ï¼š<br>(é»é¸å¾Œå°‡ç„¡æ³•æ›´æ”¹)</div>
            <div class="prize-list" id="finalList"></div>
            <button class="action-btn" onclick="confirmSelection()" disabled id="confirmBtn">è«‹å…ˆé¸æ“‡ä¸€å€‹çå“</button>
        </div>
    </div>

    <div style="margin-top: 30px; text-align: center;">
        <button onclick="resetGame()" style="background: #333; color: #fff; border: 1px solid #555; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            ğŸ› ï¸ æ¸…é™¤ç´€éŒ„ (é‡æ¸¬ç”¨)
        </button>
    </div>
    
    <script>
        // æŠŠé€™å€‹å‡½å¼åŠ åœ¨ <script> è£¡é¢çš„ä»»æ„ä½ç½® (ä¾‹å¦‚æ”¾åœ¨æœ€å¾Œé¢)
        function resetGame() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡ä¾†å—ï¼Ÿ")) {
                localStorage.clear(); // æ¸…ç©ºæ‰€æœ‰æš«å­˜
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
                window.location.reload(); // é‡æ–°æ•´ç†ç¶²é 
            }
        }
        // âœ… ä½ çš„ ID (ç¢ºèªç„¡èª¤)
        const YOUR_LIFF_ID = "2008607102-ZKoAeEga"; 

        // éŠæˆ²è®Šæ•¸
        const MAX_ROUNDS = 3;
        let currentRound = 0;
        let prizeHistory = []; 
        
        let userId = "";
        let userName = "";
        let selectedPrizeIndex = -1;

        // --- LINE LIFF åˆå§‹åŒ– ---
        function initLineLiff() {
            document.getElementById('status-msg').innerText = "æ­£åœ¨é€£æ¥ LINE...";
            liff.init({ liffId: YOUR_LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        getProfile();
                    }
                })
                .catch((err) => {
                    console.error('LIFF Error:', err);
                    document.getElementById('status-msg').innerHTML = "æ¸¬è©¦æ¨¡å¼ (æœªé€£æ¥ LINE)";
                    // æ¸¬è©¦æ¨¡å¼ä¸‹ç„¡æ³•å­˜æª”(å› ç‚ºæ²’ID)ï¼Œåƒ…ä¾›é«”é©—
                    enableGame(); 
                });
        }

        function getProfile() {
            liff.getProfile()
                .then(profile => {
                    userId = profile.userId;
                    userName = profile.displayName;

                    // =========== ğŸš§ å°é–‰æ¸¬è©¦é–å®šå€ (éœ€è¦æ™‚è§£é™¤è¨»è§£) ğŸš§ ===========
                    /*
                    const whiteList = [
                        "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", // å¡«å…¥ä½ çš„ ID
                        "Uyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy"
                    ];
                    if (!whiteList.includes(userId)) {
                        alert("ğŸš§ æŠ±æ­‰ï¼Œæœ¬æ´»å‹•ç›®å‰é€²è¡Œå…§éƒ¨æ¸¬è©¦ä¸­ ğŸš§");
                        liff.closeWindow();
                        return;
                    }
                    */
                    // ========================================================

                    document.getElementById('welcome-msg').innerText = `ğŸ„ ${userName} çš„è–èª•æ‹‰éœ¸ ğŸ„`;
                    document.getElementById('status-msg').innerText = `Hello, ${userName}ï¼ç¥ä½ å¥½é‹ï¼`;
                    
                    // 1. å…ˆæª¢æŸ¥æ˜¯å¦å·²é ˜ç (éŠæˆ²çµæŸ)
                    if (localStorage.getItem('xmas_claimed_' + userId)) {
                        lockGameAsFinished();
                        return;
                    }

                    // 2. æª¢æŸ¥æ˜¯å¦æœ‰ã€Œç©åˆ°ä¸€åŠã€çš„é€²åº¦ (é‡é»ä¿®æ­£ï¼)
                    const savedHistory = localStorage.getItem('xmas_history_' + userId);
                    if (savedHistory) {
                        prizeHistory = JSON.parse(savedHistory);
                        currentRound = prizeHistory.length;
                    }

                    enableGame();
                })
                .catch(err => {
                    console.error('Profile Error:', err);
                    enableGame();
                });
        }

        function lockGameAsFinished() {
            alert("æ‚¨å·²ç¶“é ˜å–éè–èª•ç¦®ç‰©å›‰ï¼");
            document.getElementById('status-msg').innerText = "å·²å®Œæˆé ˜å–";
            document.getElementById('round-text').innerText = "æ´»å‹•å·²çµæŸ";
            document.getElementById('spinBtn').innerText = "æ˜æ—¥å†ä¾†";
            document.getElementById('spinBtn').disabled = true;
        }

        function enableGame() {
            const btn = document.getElementById('spinBtn');
            btn.disabled = false;

            // æ ¹æ“šé€²åº¦æ¢å¾©ä»‹é¢
            if (currentRound >= MAX_ROUNDS) {
                // å¦‚æœå·²ç¶“è½‰å®Œ3æ¬¡ï¼Œä½†é‚„æ²’é ˜ç (ä¾‹å¦‚è½‰å®Œç•¶ä¸‹ç•¶æ©Ÿ/é—œæ‰)
                // ç›´æ¥å¼•å°å»é¸çå“
                btn.innerText = "æŸ¥çœ‹çå“ (3é¸1)";
                btn.onclick = showSelectionModal; // ç¶å®šç›´æ¥é–‹å•Ÿé¸æ“‡è¦–çª—
            } else {
                // é‚„æ²’è½‰å®Œï¼Œç¹¼çºŒè½‰
                btn.innerText = `é–‹å§‹ç¬¬ ${currentRound + 1} æ¬¡`;
                btn.onclick = playGame; // ç¶å®šè½‰å‹•
            }
            updateRoundText();
        }

        function updateRoundText() {
            const el = document.getElementById('round-text');
            if (currentRound >= MAX_ROUNDS) {
                el.innerText = "æŒ‘æˆ°çµæŸï¼Œè«‹é¸æ“‡çå“";
            } else {
                el.innerText = `ç›®å‰é€²åº¦ï¼šç¬¬ ${currentRound + 1} æ¬¡ (å…± 3 æ¬¡)`;
            }
        }

        // --- çé …è¨­å®š ---
        const prizes = [
            { id: 'off_80', weight: 1, symbol: 'ğŸ‘‘', text: 'æ•´å–® 8 æŠ˜åˆ¸', desc: 'å¤ªç¥å•¦ï¼æ•´å–® 8 æŠ˜å„ªæƒ ï¼', link: 'https://lin.ee/ä½ çš„8æŠ˜é€£çµ' },
            { id: 'off_90', weight: 5, symbol: 'ğŸ«', text: 'æ•´å–® 9 æŠ˜åˆ¸', desc: 'æ­å–œç²å¾—æ•´å–® 9 æŠ˜ï¼', link: 'https://lin.ee/ä½ çš„9æŠ˜é€£çµ' },
            { id: 'cash_1000', weight: 10, symbol: 'ğŸ’°', text: '1000å…ƒè³¼ç‰©é‡‘', desc: 'æ‰‹æ°£è¶…æ—ºï¼1000å…ƒæŠ˜åƒ¹åˆ¸ï¼', link: 'https://lin.ee/ä½ çš„1000å…ƒé€£çµ' },
            { id: 'cash_500', weight: 20, symbol: 'ğŸ’°', text: '500å…ƒè³¼ç‰©é‡‘', desc: 'æ­å–œç™¼è²¡ï¼500å…ƒæŠ˜åƒ¹åˆ¸ï¼', link: 'https://lin.ee/ä½ çš„500å…ƒé€£çµ' },
            { id: 'cash_200', weight: 100, symbol: 'ğŸª™', text: '200å…ƒè³¼ç‰©é‡‘', desc: 'å¥½é‹åˆ°ï¼200å…ƒæŠ˜åƒ¹åˆ¸ï¼', link: 'https://lin.ee/ä½ çš„200å…ƒé€£çµ' },
            { id: 'cash_100', weight: 300, symbol: 'ğŸª™', text: '100å…ƒè³¼ç‰©é‡‘', desc: 'æš–å¿ƒå¥½ç¦®ï¼100å…ƒæŠ˜åƒ¹åˆ¸ï¼', link: 'https://lin.ee/ä½ çš„100å…ƒé€£çµ' },
            { id: 'gift_mix', weight: 50, symbol: 'ğŸ', text: 'å¯¦é«”å¥½ç¦®å…Œæ›', desc: 'ç›¥æ´—åŒ…/å£ç½©/ç‰™åˆ·çµ„ ä¸‰é¸ä¸€', link: 'https://lin.ee/ä½ çš„è´ˆå“é€£çµ' }
        ];

        function getRandomPrize() {
            let totalWeight = 0;
            prizes.forEach(p => totalWeight += p.weight);
            let randomNum = Math.random() * totalWeight;
            for (let i = 0; i < prizes.length; i++) {
                randomNum -= prizes[i].weight;
                if (randomNum <= 0) return prizes[i];
            }
            return prizes[prizes.length - 1];
        }

        const reel1 = document.getElementById('reel1');
        const reel2 = document.getElementById('reel2');
        const reel3 = document.getElementById('reel3');
        const spinBtn = document.getElementById('spinBtn');

        function playGame() {
            if (currentRound >= MAX_ROUNDS) return;

            spinBtn.disabled = true;
            spinBtn.innerText = "é‹è½‰ä¸­...";
            
            let interval = setInterval(() => {
                reel1.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
                reel2.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
                reel3.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
            }, 100);

            let result = getRandomPrize();
            prizeHistory.push(result);

            // ğŸ”¥ é‡é»ï¼šå­˜æª”ï¼é˜²æ­¢é‡æ–°æ•´ç†å¾Œé€²åº¦æ¶ˆå¤±
            if (userId) {
                localStorage.setItem('xmas_history_' + userId, JSON.stringify(prizeHistory));
            }

            setTimeout(() => {
                clearInterval(interval);
                reel1.innerText = result.symbol;
                reel2.innerText = result.symbol;
                reel3.innerText = result.symbol;
                setTimeout(() => { showResultModal(result); }, 500);
            }, 1000);
        }

        function showResultModal(prize) {
            const modal = document.getElementById('resultModal');
            document.getElementById('modalTitle').innerText = prize.text;
            document.getElementById('modalDesc').innerText = prize.desc;
            
            const imgDiv = document.getElementById('modalImg');
            if (prize.image) imgDiv.innerHTML = `<img src="${prize.image}">`;
            else imgDiv.innerText = prize.symbol;

            const btn = document.getElementById('modalBtn');
            if (prizeHistory.length < MAX_ROUNDS) {
                btn.innerText = `æ”¾å…¥èƒŒåŒ…ï¼Œè½‰ç¬¬ ${prizeHistory.length + 1} æ¬¡`;
                btn.onclick = nextRound;
            } else {
                btn.innerText = "æŸ¥çœ‹æ‰€æœ‰çå“ (3é¸1)";
                btn.onclick = showSelectionModal;
            }
            modal.style.display = 'flex';
        }

        function nextRound() {
            document.getElementById('resultModal').style.display = 'none';
            currentRound++;
            updateRoundText();
            const btn = document.getElementById('spinBtn');
            btn.disabled = false;
            btn.innerText = `é–‹å§‹ç¬¬ ${currentRound + 1} æ¬¡`;
        }

        function showSelectionModal() {
            document.getElementById('resultModal').style.display = 'none';
            const modal = document.getElementById('selectionModal');
            const list = document.getElementById('finalList');
            list.innerHTML = "";

            prizeHistory.forEach((prize, index) => {
                const item = document.createElement('div');
                item.className = 'prize-item';
                item.innerHTML = `
                    <div class="prize-icon">${prize.symbol}</div>
                    <div class="prize-info">
                        <div class="prize-name">${prize.text}</div>
                        <div class="prize-sub">ç¬¬ ${index + 1} æ¬¡è½‰å‡º</div>
                    </div>
                `;
                item.onclick = () => selectPrize(index, item);
                list.appendChild(item);
            });
            modal.style.display = 'flex';
        }

        function selectPrize(index, element) {
            document.querySelectorAll('.prize-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedPrizeIndex = index;
            const btn = document.getElementById('confirmBtn');
            btn.disabled = false;
            btn.innerText = "ç¢ºèªé ˜å–ï¼š" + prizeHistory[index].text;
            btn.style.background = "#2ecc71";
        }

        function confirmSelection() {
            if (selectedPrizeIndex === -1) return;
            const finalPrize = prizeHistory[selectedPrizeIndex];
            
            if (userId) {
                localStorage.setItem('xmas_claimed_' + userId, 'true');
            }

            if (finalPrize.link) {
                if (liff.isInClient()) {
                    liff.openWindow({ url: finalPrize.link, external: false });
                } else {
                    window.location.href = finalPrize.link;
                }
            } else {
                alert("é ˜å–æˆåŠŸï¼(ç„¡é€£çµ)");
            }
            liff.closeWindow(); 
        }

        window.onload = function() {
            initLineLiff();
        };
    </script>
</body>
</html>
