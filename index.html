<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•æ‹‰éœ¸æ´»å‹•</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- æ¨£å¼å€ (ç¶­æŒ V18 è±ªè¯ç´…é‡‘ç‰ˆ) --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: radial-gradient(circle at center, #a32626 0%, #5c0e0e 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            overflow-y: auto;
        }
        h1 {
            color: #f8d85c;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7), 0 0 10px rgba(248, 216, 92, 0.3);
            margin-bottom: 5px; /* ç¨å¾®ç¸®å°é–“è· */
            font-size: clamp(1.5rem, 5vw, 2rem);
            text-align: center;
        }
        /* æ–°å¢å‰¯æ¨™é¡Œæ¨£å¼ */
        .subtitle {
            color: #fff;
            font-size: 1rem;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 15px;
        }

        .info-text { font-size: 0.9rem; color: #ddd; margin-bottom: 10px; text-align: center;}
        
        .round-indicator {
            background: rgba(0,0,0,0.4);
            padding: 5px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #f8d85c;
            border: 1px solid rgba(248, 216, 92, 0.3);
        }

        .machine-container {
            background: linear-gradient(to bottom, #fbe484, #d4a00d, #9e7606, #d4a00d, #fbe484);
            padding: 6px;
            border-radius: 22px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), 0 0 20px rgba(248, 216, 92, 0.5) inset;
            width: 95%;
            max-width: 350px;
            min-width: 280px;
            text-align: center;
            position: relative;
        }

        .machine-inner {
            background: linear-gradient(160deg, #c0392b, #912317);
            border-radius: 18px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.4);
        }

        .slots-window {
            background-color: #fff;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 5px;
            border: 3px solid #e0e0e0;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.3);
            width: 100%;
        }
        .reel {
            font-size: clamp(2.5rem, 10vw, 3.5rem);
            width: 33%;
            height: 70px;
            line-height: 75px;
            text-align: center;
            border-right: 2px solid #ddd;
            color: #333;
            display: flex; align-items: center; justify-content: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .reel:last-child { border-right: none; }
        .reel img { width: 80%; height: 80%; object-fit: contain; }
        
        .spin-btn {
            background: linear-gradient(to bottom, #fbe484, #d4a00d);
            border: none;
            padding: 15px 0;
            width: 100%;
            font-size: 1.5rem;
            color: #5c3a00;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #9e7606, 0 2px 10px rgba(248, 216, 92, 0.4);
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
            transition: all 0.1s;
        }
        .spin-btn:active { transform: translateY(5px); box-shadow: 0 1px 0 #9e7606; }
        .spin-btn:disabled { background: #95a5a6; color: #555; cursor: not-allowed; box-shadow: none; transform: translateY(5px); text-shadow: none;}
        
        .btn-claimed {
            background: linear-gradient(to bottom, #2ecc71, #27ae60) !important;
            box-shadow: 0 6px 0 #1e8449 !important;
            color: #fff !important;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(8px);
            padding: 20px;
        }
        .modal-content {
            background: #fff; color: #333;
            width: 100%; max-width: 340px;
            padding: 3px;
            border-radius: 20px;
            text-align: center; position: relative;
            background: linear-gradient(135deg, #fbe484, #d4a00d);
            box-shadow: 0 0 30px rgba(248, 216, 92, 0.4);
            animation: popIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-inner-content {
            background: #fff;
            border-radius: 17px;
            padding: 20px 15px;
        }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .modal-img-placeholder {
            width: 100px; height: 100px;
            background-color: #fafafa;
            margin: 0 auto 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem;
            border-radius: 10px; border: 2px dashed #ccc;
        }
        .modal-img-placeholder img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }

        .modal-title { font-size: 1.4rem; color: #c0392b; margin-bottom: 8px; font-weight: bold; }
        
        .modal-desc { 
            font-size: 0.95rem; 
            color: #555; 
            margin-bottom: 20px; 
            line-height: 1.6; 
            text-align: left;
            padding: 0 10px;
        }
        
        .action-btn { background: linear-gradient(to bottom, #2ecc71, #27ae60); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 1.1rem; cursor: pointer; width: 100%; margin-bottom: 10px; box-shadow: 0 4px 0 #1e8449; transition: transform 0.1s;}
        .action-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #1e8449;}
        
        .prize-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .prize-item {
            border: 2px solid #eee; border-radius: 10px; padding: 10px;
            display: flex; align-items: center; text-align: left;
            transition: all 0.2s; cursor: pointer;
        }
        .prize-item:hover { border-color: #d4a00d; background: #fffdf0; }
        .prize-item.selected { border-color: #c0392b; background: #fff0f0; border-width: 3px; }
        
        .prize-icon { font-size: 2rem; margin-right: 15px; width: 40px; text-align: center;}
        .prize-info { flex: 1; }
        .prize-name { font-weight: bold; color: #333; font-size: 1rem;}
        .prize-sub { font-size: 0.8rem; color: #777; }
        
        .snow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; background-image: url('data:image/svg+xml;utf8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="2" fill="white" opacity="0.2"/></svg>'); animation: snow 10s linear infinite; }
        @keyframes snow { from { background-position: 0 0; } to { background-position: 0 500px; } }
    </style>
</head>
<body>
    <div class="snow"></div>
    <h1 id="welcome-msg">ğŸ„ è–èª•å¥½ç¦®æ‹‰éœ¸ ğŸ„</h1>
    
    <div class="subtitle">âœ¨ æ¶ˆè²»æ»¿åƒå³å¯åƒåŠ  âœ¨</div>
    
    <div class="info-text" id="status-msg">é€£ç·šä¸­...</div>
    <div class="round-indicator" id="round-text">æº–å‚™é–‹å§‹ (0/3)</div>

    <div class="machine-container">
        <div class="machine-inner">
            <div class="slots-window">
                <div class="reel" id="reel1">ğŸ…</div>
                <div class="reel" id="reel2">ğŸ…</div>
                <div class="reel" id="reel3">ğŸ…</div>
            </div>
            <button class="spin-btn" id="spinBtn" onclick="playGame()" disabled>è¼‰å…¥ä¸­...</button>
        </div>
    </div>

    <div style="margin-top: 40px; text-align: center; z-index: 999;">
        <button onclick="resetGame()" style="background: #e74c3c; color: #fff; border: 2px solid #fff; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
            ğŸ”„ æ¸…é™¤ç´€éŒ„ (é‡æ¸¬ç”¨)
        </button>
        <p style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">(é€™æ˜¯æ¸¬è©¦æŒ‰éˆ•ï¼Œæ­£å¼æ´»å‹•æ™‚è«‹åˆªé™¤)</p>
    </div>

    <div class="modal-overlay" id="resultModal">
        <div class="modal-content">
            <div class="modal-inner-content">
                <div class="modal-img-placeholder" id="modalImg">ğŸ</div>
                <div class="modal-title" id="modalTitle">æ¨™é¡Œ</div>
                <div class="modal-desc" id="modalDesc">æ•˜è¿°</div>
                <button class="action-btn" id="modalBtn" onclick="nextRound()">æ”¾å…¥èƒŒåŒ…ï¼Œç¹¼çºŒè½‰</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="selectionModal">
        <div class="modal-content">
            <div class="modal-inner-content">
                <div class="modal-title">ğŸ‰ æ­å–œå®Œæˆï¼</div>
                <div class="modal-desc">æ‚¨æœ‰ 3 æ¬¡ä¸­çç´€éŒ„ï¼Œè«‹ **æ“‡ä¸€** é ˜å–ï¼š<br>(é»é¸å¾Œå°‡ç„¡æ³•æ›´æ”¹)</div>
                <div class="prize-list" id="finalList"></div>
                <button class="action-btn" onclick="confirmSelection()" disabled id="confirmBtn">è«‹å…ˆé¸æ“‡ä¸€å€‹çå“</button>
            </div>
        </div>
    </div>

    <script>
        // âœ… LIFF ID
        const YOUR_LIFF_ID = "2008607102-ZKoAeEga"; 

        // éŠæˆ²è®Šæ•¸
        const MAX_ROUNDS = 3;
        let currentRound = 0;
        let prizeHistory = []; 
        let userId = "";
        let userName = "";
        let selectedPrizeIndex = -1;

        // --- ğŸ çé …è¨­å®š (V19 æ»¿åƒè´ˆç¦®ç‰ˆ) ---
        // weight è¨­å®šï¼šæ•¸å­—è¶Šå¤§è¶Šå®¹æ˜“ä¸­
        const prizes = [
            // ğŸ”´ ä¸€çï¼šå¤§ç (REN/JMO)
            { 
                id: 'prize_1_wash', 
                weight: 10,  // è¼ƒç¨€æœ‰
                symbol: 'ğŸ§´', 
                text: 'ä¸€çï¼šæ˜Ÿç´šæ´—æ²æ­£è²¨', 
                desc: 'æ­å–œç²å¾—ä¸€çï¼<br>REN æˆ– JMO æ´—æ²ç³»åˆ—ä¾ç¾å ´åº«å­˜æ“‡ä¸€è´ˆé€ï¼<br><span style="color:#aaa; font-size:0.8rem;">(åƒ¹å€¼ä¸è²ï¼ŒçŠ’è³è‡ªå·±é¦–é¸)</span>', 
                link: 'https://lin.ee/ä½ çš„çå“1é€£çµ' 
            },
            
            // ğŸ”´ äºŒçï¼šç›¥æ´—åŒ…+æ‹–é‹ (ä¸­ç­‰æ©Ÿç‡)
            { 
                id: 'prize_2_set', 
                weight: 30, 
                symbol: 'ğŸ‘', 
                text: 'äºŒçï¼šç›¥æ´—åŒ…+æ‹–é‹çµ„', 
                desc: 'æ­å–œç²å¾—äºŒçï¼<br>å«ï¼šç›¥æ´—åŒ…*2çµ„ + ç’°ä¿æ‹–é‹*2é›™ (é¡è‰²å°ºå¯¸ä»»é¸)ï¼<br><span style="color:#aaa; font-size:0.8rem;">(å¯¦ç”¨çµ„åˆï¼Œé¦¬ä¸Šå°±èƒ½ç”¨)</span>', 
                link: 'https://lin.ee/ä½ çš„çå“2é€£çµ' 
            },

            // ğŸ”´ ä¸‰çï¼šæ—…ç”¨çµ„ (æœ€å®¹æ˜“ä¸­ - æ¸…åº«å­˜ä¸»åŠ›)
            { 
                id: 'prize_3_travel', 
                weight: 60, // æœ€å®¹æ˜“ä¸­
                symbol: 'ğŸ§³', 
                text: 'ä¸‰çï¼šç²¾ç·»æ—…ç”¨çµ„ (3çµ„)', 
                desc: 'æ­å–œç²å¾—ä¸‰çï¼<br>ä¸€æ¬¡å¸¶èµ°ã€Œæ—…ç”¨çµ„ * 3çµ„ã€ï¼Œå‡ºéŠæ—…è¡Œå¿…å‚™è‰¯ä¼´ï¼<br><span style="color:#aaa; font-size:0.8rem;">(æ•¸é‡å……è¶³ï¼Œäººäººæœ‰ç)</span>', 
                link: 'https://lin.ee/ä½ çš„çå“3é€£çµ' 
            }
        ];

        // --- æ ¸å¿ƒé‚è¼¯ (ç¶­æŒä¸è®Š) ---
        function initLineLiff() {
            document.getElementById('status-msg').innerText = "æ­£åœ¨é€£æ¥ LINE...";
            liff.init({ liffId: YOUR_LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        getProfile();
                    }
                })
                .catch((err) => {
                    console.error('LIFF Error:', err);
                    document.getElementById('status-msg').innerHTML = "æ¸¬è©¦æ¨¡å¼ (æœªé€£æ¥ LINE)";
                    enableGame(); 
                });
        }

        function getProfile() {
            liff.getProfile()
                .then(profile => {
                    userId = profile.userId;
                    userName = profile.displayName;

                    // å°é–‰æ¸¬è©¦ (é ç•™)
                    /* const whiteList = ["U..."]; if(!whiteList.includes(userId)) return; */

                    document.getElementById('welcome-msg').innerText = `ğŸ„ ${userName} çš„è–èª•æ‹‰éœ¸ ğŸ„`;
                    document.getElementById('status-msg').innerText = `Hello, ${userName}ï¼ç¥ä½ å¥½é‹ï¼`;
                    
                    const wonPrizeName = localStorage.getItem('xmas_won_prize_' + userId);
                    const wonPrizeLink = localStorage.getItem('xmas_won_link_' + userId);

                    if (localStorage.getItem('xmas_claimed_' + userId)) {
                        lockGameAsFinished(wonPrizeName, wonPrizeLink);
                        return;
                    }

                    const savedHistory = localStorage.getItem('xmas_history_' + userId);
                    if (savedHistory) {
                        prizeHistory = JSON.parse(savedHistory);
                        currentRound = prizeHistory.length;
                    }

                    enableGame();
                })
                .catch(err => {
                    console.error('Profile Error:', err);
                    enableGame();
                });
        }

        function lockGameAsFinished(prizeName, prizeLink) {
            const btn = document.getElementById('spinBtn');
            const statusMsg = document.getElementById('status-msg');
            const roundText = document.getElementById('round-text');

            roundText.innerText = "æ´»å‹•å·²å®Œæˆ";
            statusMsg.innerText = prizeName ? `æ‚¨å·²ç²å¾—ï¼š${prizeName}` : "å·²å®Œæˆé ˜å–";

            if (prizeLink) {
                btn.innerText = "ğŸ« æŸ¥çœ‹æˆ‘çš„å…Œæ›åˆ¸";
                btn.className = "spin-btn btn-claimed";
                btn.disabled = false;
                btn.onclick = function() {
                    if (liff.isInClient()) {
                        liff.openWindow({ url: prizeLink, external: false });
                    } else {
                        window.location.href = prizeLink;
                    }
                };
            } else {
                btn.innerText = "å·²å®Œæˆ";
                btn.disabled = true;
            }
        }

        function enableGame() {
            const btn = document.getElementById('spinBtn');
            btn.disabled = false;

            if (currentRound >= MAX_ROUNDS) {
                btn.innerText = "æŸ¥çœ‹çå“ (3é¸1)";
                btn.onclick = showSelectionModal; 
            } else {
                btn.innerText = `é–‹å§‹ç¬¬ ${currentRound + 1} æ¬¡`;
                btn.onclick = playGame; 
            }
            updateRoundText();
        }

        function updateRoundText() {
            const el = document.getElementById('round-text');
            if (currentRound >= MAX_ROUNDS) {
                el.innerText = "æŒ‘æˆ°çµæŸï¼Œè«‹é¸æ“‡çå“";
            } else {
                el.innerText = `ç›®å‰é€²åº¦ï¼šç¬¬ ${currentRound + 1} æ¬¡ (å…± 3 æ¬¡)`;
            }
        }

        function resetGame() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤ç´€éŒ„ä¸¦é‡ä¾†å—ï¼Ÿ")) {
                localStorage.clear(); 
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼Œç¶²é å°‡é‡æ–°æ•´ç†ï¼");
                window.location.reload(); 
            }
        }

        // ä¸é‡è¤‡çé …é‚è¼¯
        function getRandomPrize() {
            const wonIds = prizeHistory.map(p => p.id);
            const availablePrizes = prizes.filter(p => !wonIds.includes(p.id));
            
            let totalWeight = 0;
            availablePrizes.forEach(p => totalWeight += p.weight);
            
            let randomNum = Math.random() * totalWeight;

            for (let i = 0; i < availablePrizes.length; i++) {
                randomNum -= availablePrizes[i].weight;
                if (randomNum <= 0) return availablePrizes[i];
            }
            return availablePrizes[availablePrizes.length - 1];
        }

        const reel1 = document.getElementById('reel1');
        const reel2 = document.getElementById('reel2');
        const reel3 = document.getElementById('reel3');
        const spinBtn = document.getElementById('spinBtn');

        function playGame() {
            if (currentRound >= MAX_ROUNDS) return;

            spinBtn.disabled = true;
            spinBtn.innerText = "é‹è½‰ä¸­...";
            
            let interval = setInterval(() => {
                reel1.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
                reel2.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
                reel3.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
            }, 100);

            let result = getRandomPrize();
            prizeHistory.push(result);

            if (userId) {
                localStorage.setItem('xmas_history_' + userId, JSON.stringify(prizeHistory));
            }

            setTimeout(() => {
                clearInterval(interval);
                reel1.innerText = result.symbol;
                reel2.innerText = result.symbol;
                reel3.innerText = result.symbol;
                setTimeout(() => { showResultModal(result); }, 500);
            }, 1000);
        }

        function showResultModal(prize) {
            const modal = document.getElementById('resultModal');
            document.getElementById('modalTitle').innerText = prize.text;
            document.getElementById('modalDesc').innerHTML = prize.desc; 
            
            const imgDiv = document.getElementById('modalImg');
            if (prize.image) imgDiv.innerHTML = `<img src="${prize.image}">`;
            else imgDiv.innerText = prize.symbol;

            const btn = document.getElementById('modalBtn');
            if (prizeHistory.length < MAX_ROUNDS) {
                btn.innerText = `æ”¾å…¥èƒŒåŒ…ï¼Œè½‰ç¬¬ ${prizeHistory.length + 1} æ¬¡`;
                btn.onclick = nextRound;
            } else {
                btn.innerText = "æŸ¥çœ‹æ‰€æœ‰çå“ (3é¸1)";
                btn.onclick = showSelectionModal;
            }
            modal.style.display = 'flex';
        }

        function nextRound() {
            document.getElementById('resultModal').style.display = 'none';
            currentRound++;
            updateRoundText();
            const btn = document.getElementById('spinBtn');
            btn.disabled = false;
            btn.innerText = `é–‹å§‹ç¬¬ ${currentRound + 1} æ¬¡`;
        }

        function showSelectionModal() {
            document.getElementById('resultModal').style.display = 'none';
            const modal = document.getElementById('selectionModal');
            const list = document.getElementById('finalList');
            list.innerHTML = "";

            prizeHistory.forEach((prize, index) => {
                const item = document.createElement('div');
                item.className = 'prize-item';
                item.innerHTML = `
                    <div class="prize-icon">${prize.symbol}</div>
                    <div class="prize-info">
                        <div class="prize-name">${prize.text}</div>
                        <div class="prize-sub">ç¬¬ ${index + 1} æ¬¡è½‰å‡º</div>
                    </div>
                `;
                item.onclick = () => selectPrize(index, item);
                list.appendChild(item);
            });
            modal.style.display = 'flex';
        }

        function selectPrize(index, element) {
            document.querySelectorAll('.prize-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedPrizeIndex = index;
            const btn = document.getElementById('confirmBtn');
            btn.disabled = false;
            btn.innerText = "ç¢ºèªé ˜å–ï¼š" + prizeHistory[index].text;
            btn.style.background = "#2ecc71";
        }

        function confirmSelection() {
            if (selectedPrizeIndex === -1) return;
            const finalPrize = prizeHistory[selectedPrizeIndex];
            
            if (userId) {
                localStorage.setItem('xmas_claimed_' + userId, 'true');
                localStorage.setItem('xmas_won_prize_' + userId, finalPrize.text);
                if(finalPrize.link) {
                    localStorage.setItem('xmas_won_link_' + userId, finalPrize.link);
                }
            }

            if (finalPrize.link) {
                if (liff.isInClient()) {
                    liff.openWindow({ url: finalPrize.link, external: false });
                } else {
                    window.location.href = finalPrize.link;
                }
            } else {
                alert("é ˜å–æˆåŠŸï¼(ç„¡é€£çµ)");
            }
            liff.closeWindow(); 
        }

        window.onload = function() {
            initLineLiff();
        };
    </script>
</body>
</html>
