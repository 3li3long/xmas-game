<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•æ‹‰éœ¸æ´»å‹•</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- æ¨£å¼å€ --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: radial-gradient(circle at center, #2e7d32 0%, #0d2b18 100%);
            color: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; width: 100vw; margin: 0; padding: 10px;
            overflow-x: hidden; overflow-y: auto;
        }
        h1 { color: #f8d85c; text-shadow: 2px 2px 4px #000; margin-bottom: 5px; font-size: clamp(1.5rem, 5vw, 2rem); text-align: center; font-weight: 800; }
        .subtitle { color: #fff; font-size: 1rem; margin-bottom: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); background: rgba(255,255,255,0.15); padding: 5px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }
        .info-text { font-size: 0.9rem; color: #ddd; margin-bottom: 10px; text-align: center;}
        .round-indicator { background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px; margin-bottom: 10px; font-size: 0.9rem; color: #f8d85c; border: 1px solid rgba(248, 216, 92, 0.3); }
        .machine-container { background: linear-gradient(to bottom, #fbe484, #d4a00d, #9e7606, #d4a00d, #fbe484); padding: 8px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.6), 0 0 20px rgba(248, 216, 92, 0.4) inset; width: 95%; max-width: 350px; min-width: 280px; text-align: center; position: relative; z-index: 10; }
        .machine-inner { background: linear-gradient(160deg, #c0392b, #912317); border-radius: 18px; padding: 15px; display: flex; flex-direction: column; gap: 15px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.4); }
        .slots-window { background-color: #fff; border-radius: 10px; display: flex; justify-content: space-around; align-items: center; padding: 10px 5px; border: 3px solid #e0e0e0; box-shadow: inset 0 5px 15px rgba(0,0,0,0.3); width: 100%; }
        .reel { font-size: clamp(2.5rem, 10vw, 3.5rem); width: 33%; height: 70px; line-height: 75px; text-align: center; border-right: 2px solid #ddd; color: #333; display: flex; align-items: center; justify-content: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .reel:last-child { border-right: none; }
        .spin-btn { background: linear-gradient(to bottom, #fbe484, #d4a00d); border: none; padding: 15px 0; width: 100%; font-size: 1.5rem; color: #5c3a00; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 6px 0 #9e7606, 0 2px 10px rgba(248, 216, 92, 0.4); text-shadow: 0 1px 1px rgba(255,255,255,0.5); transition: all 0.1s; }
        .spin-btn:active { transform: translateY(5px); box-shadow: 0 1px 0 #9e7606; }
        .spin-btn:disabled { background: #95a5a6; color: #555; cursor: not-allowed; box-shadow: none; transform: translateY(5px); text-shadow: none;}
        .btn-claimed { background: linear-gradient(to bottom, #2ecc71, #27ae60) !important; box-shadow: 0 6px 0 #1e8449 !important; color: #fff !important; }
        
        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background: linear-gradient(135deg, #fbe484, #d4a00d); width: 100%; max-width: 340px; padding: 5px; border-radius: 22px; text-align: center; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: popInBouncy 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); max-height: 90vh; overflow-y: auto; }
        .modal-inner-content { background: #fff; border-radius: 18px; padding: 25px 20px; color: #333; }
        @keyframes popInBouncy { 0% { transform: scale(0.3); opacity: 0; } 70% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 1.4rem; color: #c0392b; margin-bottom: 8px; font-weight: 800; }
        .modal-desc { font-size: 0.95rem; color: #555; margin-bottom: 25px; line-height: 1.6; background: #f9f9f9; padding: 10px; border-radius: 10px;}
        .action-btn { background: linear-gradient(to bottom, #2ecc71, #27ae60); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 1.1rem; cursor: pointer; width: 100%; margin-bottom: 10px; box-shadow: 0 4px 0 #1e8449; font-weight: bold;}
        .prize-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px; text-align: left;}
        .prize-item { background: #fff; border: 2px solid #eee; border-radius: 15px; padding: 12px; display: flex; align-items: center; text-align: left; cursor: pointer; }
        .prize-item.selected { border-color: #c0392b; background: #ffebee; border-width: 3px;}
        .prize-icon { font-size: 2.2rem; margin-right: 15px; width: 50px; text-align: center;}
        .prize-info { flex: 1; }
        .prize-name { font-weight: 800; color: #333; }
        
        /* åˆ†åº—é¸æ“‡æŒ‰éˆ• */
        .branch-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: #fff; color: #333; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; text-align: left; position: relative; }
        .branch-btn:hover { border-color: #d4a00d; background-color: #fffdf0; }
        .branch-btn:after { content: 'ğŸ‘‰'; position: absolute; right: 15px; }

        .snow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; background-image: url('data:image/svg+xml;utf8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="2" fill="white" opacity="0.3"/></svg>'); animation: snow 10s linear infinite; }
        @keyframes snow { from { background-position: 0 0; } to { background-position: 0 500px; } }
    </style>
</head>
<body>
    <div class="snow"></div>
    
    <h1 id="welcome-msg">ğŸ„ è–èª•å¥½ç¦®æ‹‰éœ¸ ğŸ„</h1>
    <div class="subtitle">âœ¨ æ¶ˆè²»æ»¿åƒå³å¯åƒåŠ  âœ¨</div>
    
    <div class="info-text" id="status-msg">é€£ç·šä¸­...</div>
    <div class="round-indicator" id="round-text">æº–å‚™é–‹å§‹ (0/3)</div>

    <div class="machine-container">
        <div class="machine-inner">
            <div class="slots-window">
                <div class="reel" id="reel1">ğŸ…</div>
                <div class="reel" id="reel2">ğŸ…</div>
                <div class="reel" id="reel3">ğŸ…</div>
            </div>
            <button class="spin-btn" id="spinBtn" onclick="playGame()" disabled>è¼‰å…¥ä¸­...</button>
        </div>
    </div>

    <div style="margin-top: 40px; text-align: center; z-index: 999; position: relative;">
        <button onclick="resetGame()" style="background: #e74c3c; color: #fff; border: 2px solid #fff; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
            ğŸ”„ æ¸…é™¤ç´€éŒ„ (æ¸¬è©¦ç”¨)
        </button>
        <p style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">(æ¸…é™¤å¾Œå¯é‡æ–°é«”é©—æµç¨‹)</p>
    </div>

    <div class="modal-overlay" id="resultModal">
        <div class="modal-content">
            <div class="modal-inner-content">
                <div style="font-size:3.5rem; margin-bottom:10px;" id="modalImg">ğŸ</div>
                <div class="modal-title" id="modalTitle">æ¨™é¡Œ</div>
                <div class="modal-desc" id="modalDesc">æ•˜è¿°</div>
                <button class="action-btn" id="modalBtn" onclick="nextRound()">æ”¾å…¥èƒŒåŒ…ï¼Œç¹¼çºŒè½‰</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="selectionModal">
        <div class="modal-content">
            <div class="modal-inner-content">
                <div class="modal-title">ğŸ‰ æ­å–œå®Œæˆï¼</div>
                <div class="modal-desc" style="text-align: center;">æ‚¨æœ‰ 3 æ¬¡ä¸­çç´€éŒ„ï¼Œè«‹ **æ“‡ä¸€** é ˜å–ï¼š<br>(é»é¸å¾Œå°‡ç„¡æ³•æ›´æ”¹)</div>
                <div class="prize-list" id="finalList"></div>
                <button class="action-btn" onclick="showBranchModal()" disabled id="confirmBtn">è«‹å…ˆé¸æ“‡ä¸€å€‹çå“</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="branchModal">
        <div class="modal-content">
            <div class="modal-inner-content">
                <div class="modal-title">ğŸ“ è«‹é¸æ“‡é ˜å–åˆ†åº—</div>
                <div class="modal-desc">æ‚¨é¸æ“‡äº† <b id="selectedPrizeName" style="color:#d42426"></b><br>è«‹å•æ‚¨è¦å»å“ªè£¡é ˜å–ï¼Ÿ</div>
                <div id="branchList"></div>
            </div>
        </div>
    </div>

    <script>
        // âœ… LIFF ID
        const YOUR_LIFF_ID = "2008607102-ZKoAeEga"; 

        // ==========================================
        // ğŸ”¥ è¨­å®šå€ï¼šé€£çµè³‡æ–™åº« ğŸ”¥
        // ==========================================
        
        const branches = [
            { 
                id: 'taipei', 
                name: "å°åŒ—è¾¦å…¬å®¤", 
                urls: {
                    prize_wash: "https://line.me/R/ti/p/å°åŒ—_æ´—æ²", 
                    prize_set: "https://line.me/R/ti/p/å°åŒ—_ç›¥æ´—",
                    prize_toothbrush: "https://line.me/R/ti/p/å°åŒ—_ç‰™åˆ·"
                }
            },
            { 
                id: 'taoyuan', 
                name: "æ¡ƒåœ’ç‡Ÿæ¥­è™•", 
                urls: {
                    prize_wash: "https://line.me/R/ti/p/æ¡ƒåœ’_æ´—æ²", 
                    prize_set: "https://line.me/R/ti/p/æ¡ƒåœ’_ç›¥æ´—",
                    prize_toothbrush: "https://line.me/R/ti/p/æ¡ƒåœ’_ç‰™åˆ·"
                }
            },
            { 
                id: 'tainan', 
                name: "å°å—ç‡Ÿæ¥­è™•", 
                urls: {
                    // âœ… å°å—é€£çµ (V38 æ›´æ–°)
                    prize_wash: "https://lin.ee/wgGHc80", 
                    prize_set: "https://lin.ee/fzmH4lr",
                    prize_toothbrush: "https://lin.ee/QgBZ6gQ"
                }
            },
            { 
                id: 'yilan', 
                name: "å®œè˜­ç‡Ÿæ¥­è™•", 
                urls: {
                    prize_wash: "https://line.me/R/ti/p/å®œè˜­_æ´—æ²", 
                    prize_set: "https://line.me/R/ti/p/å®œè˜­_ç›¥æ´—",
                    prize_toothbrush: "https://line.me/R/ti/p/å®œè˜­_ç‰™åˆ·"
                }
            },
            { 
                id: 'hualien', 
                name: "èŠ±è“®ç‡Ÿæ¥­è™•", 
                urls: {
                    // âœ… èŠ±è“®é€£çµ (V34 å·²æ›´æ–°)
                    prize_wash: "https://lin.ee/Qab44th", 
                    prize_set: "https://lin.ee/bk3JGtx",
                    prize_toothbrush: "https://lin.ee/EttCa9W"
                }
            },
            { 
                id: 'taitung', 
                name: "å°æ±ç‡Ÿæ¥­è™•", 
                urls: {
                    prize_wash: "https://line.me/R/ti/p/å°æ±_æ´—æ²", 
                    prize_set: "https://line.me/R/ti/p/å°æ±_ç›¥æ´—",
                    prize_toothbrush: "https://line.me/R/ti/p/å°æ±_ç‰™åˆ·"
                }
            }
        ];

        let prizes = [
            { 
                id: 'prize_wash', 
                weight: 10,  
                symbol: 'ğŸ§´', 
                text: 'é€²å£æ˜Ÿç´šæ´—æ²å››ä»¶çµ„', 
                desc: 'è³ªæ„Ÿå¥½ç¦®ï¼REN æˆ– JMO æ´—æ²ç³»åˆ—ä¾ç¾å ´åº«å­˜æ“‡ä¸€è´ˆé€ï¼'
            },
            { 
                id: 'prize_set', 
                weight: 30, 
                symbol: 'ğŸ‘', 
                text: 'æ—…ç”¨ç›¥æ´—åŒ…*2+æ‹–é‹*2é›™', 
                desc: 'å¯¦ç”¨å¥½ç¦®ï¼å«æ—…ç”¨ç›¥æ´—åŒ…*2çµ„ + ç’°ä¿æ‹–é‹*2é›™ï¼'
            },
            { 
                id: 'prize_toothbrush', 
                weight: 60,
                symbol: 'ğŸ§³', 
                text: 'æ—…ç”¨ç‰™åˆ·ç‰™è†çµ„(*3)', 
                desc: 'è²¼å¿ƒå¥½ç¦®ï¼ä¸€æ¬¡å¸¶èµ°ã€Œæ—…ç”¨ç‰™åˆ·ç‰™è†çµ„ * 3çµ„ã€ï¼'
            }
        ];

        // ==========================================
        // æ ¸å¿ƒç¨‹å¼ç¢¼
        // ==========================================

        const MAX_ROUNDS = 3;
        let currentRound = 0;
        let prizeHistory = []; 
        let userId = "";
        let userName = "";
        let selectedPrizeIndex = -1;

        function initLineLiff() {
            document.getElementById('status-msg').innerText = "æ­£åœ¨é€£æ¥ LINE...";
            liff.init({ liffId: YOUR_LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        getProfile();
                    }
                })
                .catch((err) => {
                    console.error('LIFF Error:', err);
                    document.getElementById('status-msg').innerHTML = "æ¸¬è©¦æ¨¡å¼ (æœªé€£æ¥ LINE)";
                    enableGame(); 
                });
        }

        function getProfile() {
            liff.getProfile()
                .then(profile => {
                    userId = profile.userId;
                    userName = profile.displayName;
                    document.getElementById('welcome-msg').innerText = `ğŸ„ ${userName} çš„æ‹‰éœ¸ ğŸ„`;
                    document.getElementById('status-msg').innerText = `Hello, ${userName}ï¼`;
                    
                    const wonPrizeName = localStorage.getItem('xmas_won_prize_' + userId);
                    const wonPrizeLink = localStorage.getItem('xmas_won_link_' + userId);

                    if (localStorage.getItem('xmas_claimed_' + userId)) {
                        lockGameAsFinished(wonPrizeName, wonPrizeLink);
                        return;
                    }

                    const savedHistory = localStorage.getItem('xmas_history_' + userId);
                    if (savedHistory) {
                        prizeHistory = JSON.parse(savedHistory);
                        currentRound = prizeHistory.length;
                    }

                    enableGame();
                })
                .catch(err => {
                    enableGame();
                });
        }

        function enableGame() {
            const btn = document.getElementById('spinBtn');
            btn.disabled = false;
            
            if (currentRound >= MAX_ROUNDS) {
                btn.innerText = "æŸ¥çœ‹çå“ (3é¸1)";
                btn.onclick = showSelectionModal; 
            } else {
                btn.innerText = `é–‹å§‹ç¬¬ ${currentRound + 1} æ¬¡`;
                btn.onclick = playGame; 
            }
            updateRoundText();
        }

        function lockGameAsFinished(prizeName, prizeLink) {
            const btn = document.getElementById('spinBtn');
            const roundText = document.getElementById('round-text');
            const statusMsg = document.getElementById('status-msg');

            roundText.innerText = "æ´»å‹•å·²å®Œæˆ";
            statusMsg.innerText = prizeName ? `å·²ç²å¾—ï¼š${prizeName}` : "å·²å®Œæˆé ˜å–";

            if (prizeLink) {
                btn.innerText = "ğŸ« æŸ¥çœ‹æˆ‘çš„å…Œæ›åˆ¸";
                btn.className = "spin-btn btn-claimed";
                btn.disabled = false;
                btn.onclick = function() {
                    window.location.href = prizeLink;
                };
            } else {
                btn.innerText = "å·²å®Œæˆ";
                btn.disabled = true;
            }
        }

        function updateRoundText() {
            const el = document.getElementById('round-text');
            if (currentRound >= MAX_ROUNDS) {
                el.innerText = "æŒ‘æˆ°çµæŸï¼Œè«‹é¸æ“‡çå“";
            } else {
                el.innerText = `é€²åº¦ï¼š${currentRound + 1} / 3`;
            }
        }

        function resetGame() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡ä¾†å—ï¼Ÿ")) {
                localStorage.clear(); 
                alert("ç´€éŒ„å·²æ¸…é™¤ï¼");
                window.location.reload(); 
            }
        }

        // éš¨æ©ŸæŠ½é¸ï¼ˆç¢ºä¿ä¸é‡è¤‡ï¼‰
        function getRandomPrize() {
            // æ‰¾å‡ºå·²ç¶“æŠ½éçš„ ID
            const wonIds = prizeHistory.map(p => p.id);
            // æ¿¾å‡ºé‚„æ²’æŠ½éçš„çå“
            let availablePrizes = prizes.filter(p => !wonIds.includes(p.id));

            // é˜²å‘†ï¼šå¦‚æœè¬ä¸€å…¨æŠ½éäº†ï¼Œå°±å¾å…¨éƒ¨æŠ½
            if (availablePrizes.length === 0) availablePrizes = prizes;

            let totalWeight = 0;
            availablePrizes.forEach(p => totalWeight += p.weight);
            let randomNum = Math.random() * totalWeight;

            for (let i = 0; i < availablePrizes.length; i++) {
                randomNum -= availablePrizes[i].weight;
                if (randomNum <= 0) return availablePrizes[i];
            }
            return availablePrizes[availablePrizes.length - 1];
        }

        const reel1 = document.getElementById('reel1');
        const reel2 = document.getElementById('reel2');
        const reel3 = document.getElementById('reel3');
        const spinBtn = document.getElementById('spinBtn');

        function playGame() {
            if (currentRound >= MAX_ROUNDS) return;
            spinBtn.disabled = true;
            spinBtn.innerText = "é‹è½‰ä¸­...";
            
            let interval = setInterval(() => {
                reel1.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
                reel2.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
                reel3.innerText = ["ğŸ…","ğŸ„","ğŸ","ğŸ’°"][Math.floor(Math.random()*4)];
            }, 100);

            let result = getRandomPrize();
            prizeHistory.push(result);

            if (userId) {
                localStorage.setItem('xmas_history_' + userId, JSON.stringify(prizeHistory));
            }

            setTimeout(() => {
                clearInterval(interval);
                reel1.innerText = result.symbol;
                reel2.innerText = result.symbol;
                reel3.innerText = result.symbol;
                setTimeout(() => { showResultModal(result); }, 500);
            }, 1000);
        }

        function showResultModal(prize) {
            const modal = document.getElementById('resultModal');
            document.getElementById('modalTitle').innerText = prize.text;
            document.getElementById('modalDesc').innerHTML = prize.desc; 
            document.getElementById('modalImg').innerText = prize.symbol;
            
            const btn = document.getElementById('modalBtn');
            if (prizeHistory.length < MAX_ROUNDS) {
                btn.innerText = `æ”¾å…¥èƒŒåŒ…ï¼Œè½‰ç¬¬ ${prizeHistory.length + 1} æ¬¡`;
                btn.onclick = nextRound;
            } else {
                btn.innerText = "æŸ¥çœ‹æ‰€æœ‰çå“ (3é¸1)";
                btn.onclick = showSelectionModal;
            }
            modal.style.display = 'flex';
        }

        function nextRound() {
            document.getElementById('resultModal').style.display = 'none';
            currentRound++;
            updateRoundText();
            enableGame();
        }

        function showSelectionModal() {
            document.getElementById('resultModal').style.display = 'none';
            const modal = document.getElementById('selectionModal');
            const list = document.getElementById('finalList');
            list.innerHTML = "";

            prizeHistory.forEach((prize, index) => {
                const item = document.createElement('div');
                item.className = 'prize-item';
                item.innerHTML = `
                    <div class="prize-icon">${prize.symbol}</div>
                    <div class="prize-info">
                        <div class="prize-name">${prize.text}</div>
                        <div class="prize-sub">ç¬¬ ${index + 1} æ¬¡è½‰å‡º</div>
                    </div>
                `;
                item.onclick = () => selectPrize(index, item);
                list.appendChild(item);
            });
            modal.style.display = 'flex';
        }

        function selectPrize(index, element) {
            document.querySelectorAll('.prize-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedPrizeIndex = index;
            const btn = document.getElementById('confirmBtn');
            btn.disabled = false;
            btn.innerText = "ä¸‹ä¸€æ­¥ï¼šé¸æ“‡é ˜å–åˆ†åº—";
            btn.style.background = "#2ecc71";
        }

        function showBranchModal() {
            if (selectedPrizeIndex === -1) return;
            const prizeName = prizeHistory[selectedPrizeIndex].text;
            
            document.getElementById('selectionModal').style.display = 'none';
            
            document.getElementById('selectedPrizeName').innerText = prizeName;
            const modal = document.getElementById('branchModal');
            const list = document.getElementById('branchList');
            list.innerHTML = '';

            branches.forEach(branch => {
                const btn = document.createElement('button');
                btn.className = 'branch-btn';
                btn.textContent = branch.name;
                // è¨­å®šé»æ“Šäº‹ä»¶
                btn.onclick = () => finalizeClaim(branch);
                list.appendChild(btn);
            });

            modal.style.display = 'flex';
        }

        function finalizeClaim(branch) {
            const finalPrize = prizeHistory[selectedPrizeIndex];
            
            // å¾åˆ†åº—è³‡æ–™ä¸­ï¼Œæ‰¾å‡ºè©²çå“å°æ‡‰çš„é€£çµ
            const targetLink = branch.urls[finalPrize.id];

            if (userId) {
                localStorage.setItem('xmas_claimed_' + userId, 'true');
                localStorage.setItem('xmas_won_prize_' + userId, finalPrize.text);
                localStorage.setItem('xmas_branch_' + userId, branch.name);
                if(targetLink) {
                    localStorage.setItem('xmas_won_link_' + userId, targetLink);
                }
            }

            if (targetLink) {
                window.location.href = targetLink;
            } else {
                alert("æ­¤åˆ†åº—æš«ç„¡æ­¤çå“é€£çµï¼Œè«‹è¯ç¹«ç®¡ç†å“¡");
            }
            // liff.closeWindow(); 
        }

        window.onload = function() {
            initLineLiff();
        };
    </script>
</body>
</html>
